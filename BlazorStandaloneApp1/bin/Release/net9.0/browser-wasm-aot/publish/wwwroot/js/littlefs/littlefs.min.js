/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /gh/adafruit/littlefs-pure-js@1.0.3/littlefs.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
const LFS_ERR_OK=0,LFS_ERR_IO=-5,LFS_ERR_CORRUPT=-84,LFS_ERR_NOENT=-2,LFS_ERR_EXIST=-17,LFS_ERR_NOTDIR=-20,LFS_ERR_ISDIR=-21,LFS_ERR_NOTEMPTY=-39,LFS_ERR_BADF=-9,LFS_ERR_FBIG=-27,LFS_ERR_INVAL=-22,LFS_ERR_NOSPC=-28,LFS_ERR_NOMEM=-12,LFS_ERR_NOATTR=-61,LFS_ERR_NAMETOOLONG=-36,LFS_DISK_VERSION=131072,LFS_DISK_VERSION_MAJOR=2,LFS_DISK_VERSION_MINOR=0,LFS_NAME_MAX=32,LFS_FILE_MAX=2147483647,LFS_ATTR_MAX=1022,LFS_BLOCK_NULL=-1,LFS_BLOCK_INLINE=-2,LFS_TYPE_REG=1,LFS_TYPE_DIR=2,LFS_TYPE_SPLICE=1024,LFS_TYPE_NAME=0,LFS_TYPE_STRUCT=512,LFS_TYPE_USERATTR=768,LFS_TYPE_FROM=256,LFS_TYPE_TAIL=1536,LFS_TYPE_GLOBALS=1792,LFS_TYPE_CRC=1280,LFS_TYPE_CREATE=1025,LFS_TYPE_DELETE=1279,LFS_TYPE_SUPERBLOCK=255,LFS_TYPE_DIRSTRUCT=512,LFS_TYPE_CTZSTRUCT=514,LFS_TYPE_INLINESTRUCT=513,LFS_TYPE_SOFTTAIL=1536,LFS_TYPE_HARDTAIL=1537,LFS_TYPE_MOVESTATE=2047,LFS_FROM_NOOP=0,LFS_FROM_MOVE=257,LFS_FROM_USERATTRS=258,LFS_CMP_EQ=0,LFS_CMP_LT=1,LFS_CMP_GT=2,LFS_F_DIRTY=65536,LFS_F_WRITING=131072,LFS_F_READING=262144,LFS_F_ERRED=524288,LFS_F_INLINE=1048576,LFS_O_RDONLY=1,LFS_O_WRONLY=2,LFS_O_RDWR=3,LFS_O_CREAT=256,LFS_O_EXCL=512,LFS_O_TRUNC=1024,LFS_O_APPEND=2048;function toHex(t,e=2){return"0x"+t.toString(16).toUpperCase().padStart(e,"0")}function toByteArray(t){let e=[];for(let i=0;i<t.length;i++){let s=t.charCodeAt(i);s<=255&&e.push(s)}return e}class LittleFS{constructor(t){this.rcache=new Cache,this.pcache=new Cache,this.root=new Uint8Array(2),this.mList=new MList,this.seed=0,this.gstate=new GState({tag:0}),this.gdisk=new GState({tag:0}),this.gdelta=new GState({tag:0}),this.free={off:-1,size:-1,i:-1,ack:-1,buffer:null},this.nameMax=0,this.fileMax=0,this.attrMax=0,this.init(t)}init(t){t&&(this.cfg=t),console.assert(0!=this.cfg.readSize),console.assert(0!=this.cfg.progSize),console.assert(0!=this.cfg.cacheSize),console.assert(this.cfg.cacheSize%this.cfg.readSize==0),console.assert(this.cfg.cacheSize%this.cfg.progSize==0),console.assert(this.cfg.blockSize%this.cfg.cacheSize==0),console.assert(4*this.npw2(4294967295/(this.cfg.blockSize-8))<=this.cfg.blockSize),console.assert(0!=this.cfg.blockCycles),this.cfg.readBuffer?this.rcache.buffer=this.cfg.readBuffer:this.rcache.buffer=new Uint8Array(this.cfg.cacheSize),this.cfg.progBuffer?this.pcache.buffer=this.cfg.progBuffer:this.pcache.buffer=new Uint8Array(this.cfg.cacheSize),this.cacheZero(this.rcache),this.cacheZero(this.pcache),console.assert(this.cfg.lookaheadSize>0),console.assert(this.cfg.lookaheadSize%8==0&&this.cfg.lookaheadBuffer%4==0),this.cfg.lookaheadBuffer?this.free.buffer=this.cfg.lookaheadBuffer:this.free.buffer=new Uint8Array(this.cfg.lookaheadSize),this.nameMax||(this.nameMax=this.cfg.nameMax),this.fileMax||(this.fileMax=this.cfg.fileMax),this.attrMax||(this.attrMax=this.cfg.attrMax),this.root[0]=-1,this.root[1]=-1,this.mList=new MList,this.seed=0,this.gdisk.tag=0,this.gstate.tag=0,this.gdelta.tag=0}deinit(){this.cfg.readBuffer||(this.rcache.buffer=null),this.cfg.progBuffer||(this.pcache.buffer=null),this.cfg.lookaheadBuffer||(this.free.buffer=null)}format(){let t;t:{{this.init(),this.free.off=0,this.free.size=Math.min(this.cfg.lookaheadSize,this.cfg.blockSize),this.free.i=0,this.allocAck();let e=new MDir;if(t=this.dirAlloc(e),t)return;let i=new SuperBlock({version:131072,blockSize:this.cfg.blockSize,blockCount:this.cfg.blockCount,nameMax:this.nameMax,fileMax:this.fileMax,attrMax:this.attrMax});if(this.tagId(24576),this.superblockTole32(i),this.dirCommit(e,this.mkAttrs([this.mkTag(1025,0,0),null],[this.mkTag(255,0,8),"littlefs"],[this.mkTag(513,0,struct.calcsize("IIIIII")),i])),t=this.dirCommit(e,null),t)break t;if(t=this.dirFetch(e,[0,1]),t)break t}}return this.deinit(),t}allocAck(){this.free.ack=this.cfg.blockCount}dirAlloc(t){let e;for(let i=0;i<2;i++){let s=new ByRef;if(e=this.alloc(s),t.pair[(i+1)%2]=s.get(),e)return e}t.rev=0;let i=new ByRef(t.rev);return e=this.bdRead(null,this.rcache,struct.calcsize("I"),t.pair[0],0,i,struct.calcsize("I")),t.rev=i.get(),t.rev=this.fromle32(t.rev),e&&-84!=e?e:(this.cfg.blockCycles>0&&(t.rev=this.alignup(t.rev,this.cfg.blockCycles+1|1)),t.off=struct.calcsize("I"),t.etag=4294967295,t.count=0,t.tail[0]=-1,t.tail[1]=-1,t.erased=!1,t.split=!1,0)}npw2(t){let e,i=0;return e=((t-=1)>65535)<<4,i|=e,e=((t>>>=e)>255)<<3,i|=e,e=((t>>>=e)>15)<<2,i|=e,e=((t>>>=e)>3)<<1,i|=e,1+(i|(t>>>=e)>>>1)}aligndown(t,e){return t-t%e>>>0}alignup(t,e){return this.aligndown(t+e-1>>>0,e)}alloc(t){for(;;){for(;this.free.i!=this.free.size;){let e=this.free.i;if(this.free.i+=1,this.free.ack-=1,!(this.free.buffer[parseInt(this.free.i/32)]&1<<e%32)){for(t.set((this.free.off+e)%this.cfg.blockCount);this.free.i!=this.free.size&&this.free.buffer[parseInt(this.free.i/32)]&1<<this.free.i%32;)this.free.i+=1,this.free.ack-=1;return 0}}if(0==this.free.ack)return console.warn("No more free space "+this.free.i+this.free.off),-28;this.free.off=(this.free.off+this.free.size)%this.cfg.blockCount,this.free.size=Math.min(8*this.cfg.lookaheadSize,this.free.ack),this.free.i=0;let e=this.fsTraverse(this.allocLookahead.bind(this),null,!0);if(e)return this.allocDrop(),e}}pairIsnull(t){return-1==t[0]||-1==t[1]}fsTraverse(t,e,i){let s,r=new MDir;r.tail=[0,1];let a=0;for(;!this.pairIsnull(r.tail);){if(a>=this.cfg.blockCount/2)return-84;a+=1;for(let e=0;e<2;e++)if(s=t(r.tail[e]),s)return s;if(s=this.dirFetch(r,r.tail),s)return s;for(let a=0;a<r.count;a++){let h=new Ctz,c=new ByRef(new Uint8Array(struct.calcsize("II"))),l=this.dirGet(r,this.mkTag(1792,1023,0),this.mkTag(512,a,struct.calcsize("II")),c);if(h.setFromBuffer(c.get()),l<0){if(-2==l)continue;return l}if(this.ctzFromle32(h),514==this.tagType3(l)){if(s=this.ctzTraverse(this.rcache,h.head,h.size,t,e),s)return s}else if(i&&512==this.tagType3(l))for(let i=0;i<2;i++)if(s=t(e,h.head[i]),s)return s}}for(let i=this.mList;i;i=i.next)if(1==i.type){if(65536&i.flags&&!(1048576&i.flags)){let s=this.ctzTraverse(i.cache,this.rcache,i.ctz.head,i.ctz.size,t,e);if(s)return s}if(131072&i.flags&&!(1048576&i.flags)){let s=this.ctzTraverse(i.cache,this.rcache,i.block,i.pos,t,e);if(s)return s}}return 0}dirFetch(t,e){return this.dirFetchmatch(t,e,-1,-1,new ByRef(null),null,null)}dirFetchmatch(t,e,i,s,r,a,h){let c=-1;if(e[0]>=this.cfg.blockCount||e[1]>=this.cfg.blockCount)return-84;let l=[0,0],f=0,o=new ByRef;for(let t=0;t<2;t++){let i=this.bdRead(null,this.rcache,struct.calcsize("I"),e[t],0,o,struct.calcsize("I"));if(l[t]=o.get(),l[t]=this.fromle32(l[t]),i&&-84!=i)return i;-84!=i&&this.scmp(l[t],l[(t+1)%2])>0&&(f=t)}t.pair[0]=e[(f+0)%2],t.pair[1]=e[(f+1)%2],t.rev=l[(f+0)%2],t.off=0;for(let e=0;e<2;e++){let e=0,n=4294967295,g=0,u=[-1,-1],p=!1,m=c;t.rev=this.tole32(t.rev);let d=this.crc(4294967295,t.rev,struct.calcsize("I"));for(t.rev=this.fromle32(t.rev);;){let r;o=new ByRef,e+=this.tagDsize(n);let l=this.bdRead(null,this.rcache,this.cfg.blockSize,t.pair[0],e,o,struct.calcsize("I"));if(r=o.get(),l){if(-84==l){t.erased=!1;break}return l}if(d=this.crc(d,r,struct.calcsize("I")),r=(this.fromBe32(r)^n)>>>0,!this.tagIsvalid(r)){t.erased=1280==this.tagType1(n)&&t.off%this.cfg.progSize==0;break}if(e+this.tagDsize(r)>this.cfg.blockSize){t.erased=!1;break}if(n=r,1280!=this.tagType1(r)){for(let i=struct.calcsize("I");i<this.tagDsize(r);i++){let s;if(o=new ByRef,l=this.bdRead(null,this.rcache,this.cfg.blockSize,t.pair[0],e+i,o,1),l){if(-84==l){t.erased=!1;break}return l}s=o.get(),d=this.crc(d,s,1)}if(0==this.tagType1(r))this.tagId(r)>=g&&(g=this.tagId(r)+1);else if(1024==this.tagType1(r))g+=this.tagSplice(r),r==(this.mkTag(1279,0,0)|this.mkTag(0,1023,0)&m)?m|=2147483648:-1!=m&&this.tagId(r)<=this.tagId(m)&&(m+=this.mkTag(0,this.tagSplice(r),0));else if(1536==this.tagType1(r)){if(p=1&this.tagChunk(r),o=new ByRef,l=this.bdRead(null,this.rcache,this.cfg.blockSize,t.pair[0],e+struct.calcsize("I"),o,8),l&&-84==l){t.erased=!1;break}u=o.get(),this.pairFromle32(u)}if((i&r)==(i&s)){let i=a(h,r,new Diskoff({block:t.pair[0],off:e+struct.calcsize("I")}));if(i<0){if(-84==i){t.erased=!1;break}return i}0==i?m=r:(this.mkTag(2047,1023,0)&r)==(this.mkTag(2047,1023,0)&m)?m=-1:2==i&&this.tagId(r)<=this.tagId(m)&&(m=2147483648|r)}}else{let i;if(o=new ByRef,l=this.bdRead(null,this.rcache,this.cfg.blockSize,t.pair[0],e+struct.calcsize("I"),o,struct.calcsize("I")),l){if(-84==l){t.erased=!1;break}return l}if(i=o.get(),i=this.fromle32(i),d!=i){t.erased=!1;break}n^=(1&this.tagChunk(r))<<31,n>>>=0,this.seed=this.crc(this.seed,d,struct.calcsize("I")),c=m,t.off=e+this.tagDsize(r),t.etag=n,t.count=g,t.tail[0]=u[0],t.tail[1]=u[1],t.split=p,d=4294967295}}if(t.off>0)return this.gstateHasmovehere(this.gdisk,t.pair)&&(this.tagId(this.gdisk.tag)==this.tagId(c)?c|=2147483648:-1!=c&&this.tagId(this.gdisk.tag)<this.tagId(c)&&(c-=this.mkTag(0,1,0))),r.get()&&r.set(Math.min(this.tagId(c),t.count)),this.tagIsvalid(c)?c:this.tagId(c)<t.count?-2:0;this.pairSwap(t.pair),t.rev=l[(f+1)%2]}return console.warn("Corrupted dir pair at {"+t.pair[0]+", "+t.pair[1]+"}"),-84}dirFindMatch(t,e,i){let s=Math.min(t.size,this.tagSize(e)),r=this.bdCmp(null,this.rcache,s,i.block,i.off,t.name,s);return 0!=r?r:t.size!=this.tagSize(e)?t.size<this.tagSize(e)?1:2:0}allocLookahead(t){let e=(t-this.free.off+this.cfg.blockCount)%this.cfg.blockCount;if(e<this.free.size){let t=parseInt(e/32);this.free.buffer.set(this.free.buffer.slice(t,t+1)|1<<e%32,t)}}tagType1(t){return(1879048192&t)>>>20}tagType3(t){return(2146435072&t)>>>20}tagId(t){return(1047552&t)>>>10}tagDsize(t){return struct.calcsize("I")+this.tagSize(t+this.tagIsdelete(t))}tagSize(t){return 1023&t}tagIsdelete(t){return t<<22>>22==-1}tagIsvalid(t){return!(2147483648&t)}tagChunk(t){return(267386880&t)>>20&255}tagSplice(t){return this.tagChunk(t)<<24>>24}crc(t,e,i){let s;const r=[0,498536548,997073096,651767980,1994146192,1802195444,1303535960,1342533948,3988292384,4027552580,3604390888,3412177804,2607071920,2262029012,2685067896,3183342108];if(null==e)s=[];else if("string"==typeof e)s=toByteArray(e);else if("object"==typeof e){s=new Uint8Array(i);const t=parseInt(i/Object.entries(e).length);Object.values(e).forEach(((e,i)=>{s.set(LittleFS.UintToBuffer(e,t),i*t)})),s=Array.from(s)}else s=Array.from(LittleFS.UintToBuffer(e,i));for(let e=0;e<i;e++)t=((t=(t>>>4^r[15&(t^s[e]>>>0)])>>>0)>>>4^r[15&(t^s[e]>>>4)])>>>0;return t}allocDrop(){this.free.size=0,this.free.i=0,this.allocAck()}pairSwap(t){let e=t[0];t[0]=t[1],t[1]=e}gstateHasorphans(t){return!!this.tagSize(t.tag)}gstateGetorphans(t){return this.tagSize(t.tag)}gstateHasmove(t){return this.tagType1(t.tag)}gstateHasmovehere(t,e){return this.tagType1(t.tag)&&0==this.pairCmp(t.pair,e)}pairCmp(t,e){return!(t[0]==e[0]||t[1]==e[1]||t[0]==e[1]||t[1]==e[0])}static bufferToUint(t,e){const i=new DataView(t.buffer);let s=[],r=0;for(;e>0;)e>=4?(s.push(i.getUint32(r,!0)),e-=4,r+=4):e>=2?(s.push(i.getUint16(r,!0)),e-=2,r+=2):e>=1&&(s.push(i.getUint8(r,!0)),e-=1,r+=1);return 1==s.length?s[0]:s}static UintToBuffer(t,e){let i=new Uint8Array(e);const s=new DataView(i.buffer);let r=0;for(;e>0;)e>=4?(s.setUint32(r,t,!0),e-=4,r+=4):e>=2?(s.setUint16(r,t,!0),e-=2,r+=2):e>=1&&(s.setUint8(r,t,!0),e-=1,r+=1);return i}bdRead(t,e,i,s,r,a,h,c=!1){let l=new Uint8Array(h),f=0;if(s>=this.cfg.blockCount||r+h>this.cfg.blockSize)return-84;let o=h;for(;h>0;){let a=h;if(t&&s==t.block&&r<t.off+t.size){if(r>=t.off){a=Math.min(a,t.size-(r-t.off)),l.set(t.buffer.slice(r-t.off,r-t.off+a),f),f+=a,r+=a,h-=a;continue}a=Math.min(a,t.off-r)}if(s==e.block&&r<e.off+e.size){if(r>=e.off){a=Math.min(a,e.size-(r-e.off)),l.set(e.buffer.slice(r-e.off,r-e.off+a),f),f+=a,r+=a,h-=a;continue}a=Math.min(a,e.off-r)}if(h>=i&&r%this.cfg.readSize==0&&h>=this.cfg.readSize){a=this.aligndown(a,this.cfg.readSize);let t=this.cfg.read(s,r,l,a);if(t)return t;f+=a,r+=a,h-=a;continue}console.assert(s<this.cfg.blockCount),e.block=s,e.off=this.aligndown(r,this.cfg.readSize),e.size=Math.min(Math.min(this.alignup(r+i,this.cfg.readSize),this.cfg.blockSize)-e.off,this.cfg.cacheSize);let c=this.cfg.read(e.block,e.off,e.buffer,e.size);if(console.assert(c<=0),c)return c}return a.set(l),c||a.set(LittleFS.bufferToUint(a.get(),o)),0}bdFlush(t,e,i){if(-1!=t.block&&-2!=t.block){console.assert(t.block<this.cfg.blockCount);let s=this.alignup(t.size,this.cfg.progSize),r=this.cfg.prog(t.block,t.off,t.buffer,s);if(console.assert(r<=0),r)return r;if(i){this.cacheDrop(e);let i=this.bdCmp(null,e,s,t.block,t.off,t.buffer,s);if(i<0)return i;if(0!=i)return-84}this.cacheZero(t)}return 0}bdCmp(t,e,i,s,r,a,h){let c;c="string"==typeof a?toByteArray(a):a;let l=0;for(let a=0;a<h;a+=l){let f=new ByRef;l=Math.min(h-a,struct.calcsize("BBBBBBBB"));let o=this.bdRead(t,e,i-a,s,r+a,f,l,!0),n=f.get();if(o)return o;if(o=this.memcmp(n,c.slice(a),l),o)return o<0?1:2}return 0}memcmp(t,e,i){i=Math.min(t.length,e.length,i);for(let s=0;s<i;s++)if(t[s]!==e[s])return t[s]<e[s]?-1:1;return 0}bdErase(t){console.assert(t<this.cfg.blockCount);let e=this.cfg.erase(t);return console.assert(e<=0),e}bdProg(t,e,i,s,r,a,h){let c,l=0;if(null==a)c=new Uint8Array(h);else if(Array.isArray(a)){c=new Uint8Array(h);const t=parseInt(h/a.length);for(let[e,i]of a.entries())c.set(LittleFS.UintToBuffer(i,t),e*t)}else if("object"==typeof a){c=new Uint8Array(h);const t=parseInt(h/Object.entries(a).length);Object.values(a).forEach(((e,i)=>{c.set(LittleFS.UintToBuffer(e,t),i*t)}))}else"string"==typeof a?(c=new Uint8Array(h),c.set(toByteArray(a))):c=LittleFS.UintToBuffer(a,h);for(console.assert(-2==s||s<this.cfg.blockCount),console.assert(r+h<=this.cfg.blockSize);h>0;)if(s==t.block&&r>=t.off&&r<t.off+this.cfg.cacheSize){let s=Math.min(h,this.cfg.cacheSize-(r-t.off));if(t.buffer.set(c.slice(l,l+s),r-t.off),l+=s,r+=s,h-=s,t.size=Math.max(t.size,r-t.off),t.size==this.cfg.cacheSize){let s=this.bdFlush(t,e,i);if(s)return s}}else console.assert(-1==t.block),t.block=s,t.off=this.aligndown(r,this.cfg.progSize),t.size=0;return 0}bdSync(t,e,i){this.cacheDrop(e);let s=this.bdFlush(t,e,i);return s||(s=this.cfg.sync(),console.assert(s<=0),s)}mount(){let t=new MDir;t.tail=[0,1];let e,i=0;for(;!this.pairIsnull(t.tail);){i>=this.cfg.blockCount/2&&(e=-84),i+=1;let s=this.dirFetchmatch(t,t.tail,this.mkTag(2047,1023,0),this.mkTag(255,0,8),new ByRef(null),this.dirFindMatch.bind(this),new DirFindMatch({name:"littlefs",size:8}));if(s<0&&(e=s),s&&!this.tagIsdelete(s)){this.root[0]=t.pair[0],this.root[1]=t.pair[1];let i=new ByRef(new Uint8Array(struct.calcsize("IIIIII")));s=this.dirGet(t,this.mkTag(2047,1023,0),this.mkTag(513,0,i.get().byteLength),i),s<0&&(e=s);let r=new SuperBlock;r.setFromBuffer(i.get()),this.superblockFromle32(r);let a=65535&r.version>>16,h=65535&r.version>>0;(2!=a||h>0)&&(console.warn("Invalid version v"+a+"."+h),e=-22),r.nameMax&&(r.nameMax>this.nameMax&&(console.error("Unsupported nameMax ("+r.nameMax+" > "+this.nameMax+")"),e=-22),this.nameMax=r.nameMax),r.fileMax&&(r.fileMax>this.fileMax&&(console.error("Unsupported fileMax ("+r.fileMax+" > "+this.fileMax+")"),e=-22),this.fileMax=r.fileMax),r.attrMax&&(r.attrMax>this.attrMax&&(console.error("Unsupported attrMax ("+r.attrMax+" > "+this.attrMax+")"),e=-22),this.attrMax=r.attrMax)}e=this.dirGetgstate(t,this.gstate)}return this.pairIsnull(this.root)&&(e=-22),this.gstateIszero(this.gstate)||console.warn("Found pending gstate "+toHex(this.gstate.tag,8)+" "+toHex(this.gstate.pair[0],8)+" "+toHex(this.gstate.pair[1],8)),this.gstate.tag+=!this.tagIsvalid(this.gstate.tag),this.gdisk=this.gstate,this.free.off=this.seed%this.cfg.blockCount,this.allocDrop(),0}unmount(){return this.deinit()}deinit(){return 0}dirCommit(t,e){null===e&&(e=[]);for(let e=this.mList;e;e=e.next)if(t!=e.m&&0==this.pairCmp(e.m.pair,t.pair)&&1==e.type&&1048576&e.flags&&e.ctz.size>this.cfg.cacheSize){let t=this.fileOutline(e);if(t)return t;if(t=this.fileFlush(e),t)return t}let i=t,s=!1;for(let i=0;i<e.length;i++)1025==this.tagType3(e[i].tag)?t.count+=1:1279==this.tagType3(e[i].tag)?(console.assert(t.count>0),t.count-=1,s=!0):1536==this.tagType1(e[i].tag)&&(t.tail[0]=e[i].buffer[0],t.tail[1]=e[i].buffer[1],t.split=1&this.tagChunk(e[i].tag),this.pairFromle32(t.tail));if(s&&0==t.count){let e,s=this.fsPred(lfs,t.pair,e);if(s&&-2!=s)return this.copyObjProps(t,i),s;if(-2!=s&&e.split&&(s=this.dirDrop(e,t),s))return this.copyObjProps(t,i),s}let r=!1;t:{if(!(t.erased||t.count>=255)){r=!0;break t}{let s=new Commit({block:t.pair[0],off:t.off,ptag:t.etag,crc:4294967295,begin:t.off,end:(this.cfg.metadataMax?this.cfg.metadataMax:this.cfg.blockSize)-8});this.pairTole32(t.tail);let a=this.dirTraverse(t,t.off,t.etag,e,e.length,0,0,0,0,0,this.dirCommitCommit.bind(this),s);if(this.pairFromle32(t.tail),a){if(-28==a||-84==a){r=!0;break t}return this.copyObjProps(t,i),a}let h=new GState({tag:0});if(this.gstateXor(h,this.gstate),this.gstateXor(h,this.gdisk),this.gstateXor(h,this.gdelta),h.tag&=~this.mkTag(0,0,1023),!this.gstateIszero(h)){let e=this.dirGetgstate(t,h);if(e)return this.copyObjProps(t,i),e;if(this.gstateTole32(h),e=this.dirCommitattr(s,this.mkTag(2047,1023,struct.calcsize("I")),h),e){if(-28==e||-84==e){r=!0;break t}return this.copyObjProps(t,i),e}}if(a=this.dirCommitcrc(s),a){if(-28==a||-84==a){r=!0;break t}return this.copyObjProps(t,i),a}console.assert(s.off%this.cfg.progSize==0),t.off=s.off,t.etag=s.ptag,this.gdisk=this.gstate,this.gdelta=new GState({tag:0})}}if(r){this.cacheDrop(this.pcache),this.dirCompact(t,e,e.length,t,0,t.count)&&this.copyObjProps(t,i)}for(let s=this.mList;s;s=s.next)if(s.m!=t&&0==this.pairCmp(s.m.pair,i.pair)){s.m=t;for(let t=0;t<e.length;t++)1279==this.tagType3(e[t].tag)&&s.id==this.tagId(e[t].tag)?(s.m.pair[0]=-1,s.m.pair[1]=-1):1279==this.tagType3(e[t].tag)&&s.id>this.tagId(e[t].tag)?(s.id-=1,2==s.type&&(s.pos-=1)):1025==this.tagType3(e[t].tag)&&s.id>=this.tagId(e[t].tag)&&(s.id+=1,2==s.type&&(s.pos+=1))}for(let t=this.mList;t;t=t.next)if(0==this.pairCmp(t.m.pair,i.pair))for(;t.id>=t.m.count&&t.m.split;){t.id-=t.m.count;let e=this.dirFetch(t.m,t.m.tail);if(e)return e}return 0}dirCompact(t,e,i,s,r,a){const h=[t.pair[0],t.pair[1]];let c=!1,l=!1,f=!1;for(;a-r>1;){let h=0,c={size:h},l=this.dirTraverse(s,0,4294967295,e,i,this.mkTag(1024,1023,0),this.mkTag(0,0,0),r,a,-r,this.dirCommitSize.bind(this),c);if(h=c.size,l)return l;if(a-r<255&&h<=Math.min(this.cfg.blockSize-36,this.alignup((this.cfg.metadataMax?this.cfg.metadataMax:this.cfg.blockSize)/2,this.cfg.progSize)))break;let f=(a-r)/2;if(l=this.dirSplit(t,e,i,s,r+f,a),l){if(-28==l&&h<=this.cfg.blockSize-36)break;return l}a=r+f}if(t.rev+=1,this.cfg.blockCycles>0&&t.rev%(this.cfg.blockCycles+1|1)==0)if(0==this.pairCmp(t.pair,[0,1])){let h=this.fsRawsize();if(h<0)return h;if(h<this.cfg.blockCount/2){console.warn("Expanding superblock at rev "+t.rev);let h=this.dirSplit(t,e,i,s,r,a);if(h&&-28!=h)return h;h||(a=r)}}else l=!0,f=!0;t:for(;;){e:if(!f){let h=new Commit({block:t.pair[1],off:0,ptag:4294967295,crc:4294967295,begin:0,end:(this.cfg.metadataMax?this.cfg.metadataMax:this.cfg.blockSize)-8}),l=this.bdErase(t.pair[1]);if(l){if(-84==l)break e;return l}if(t.rev=this.tole32(t.rev),l=this.dirCommitprog(h,t.rev,struct.calcsize("I")),t.rev=this.fromle32(t.rev),l){if(-84==l)break e;return l}if(l=this.dirTraverse(s,0,4294967295,e,i,this.mkTag(1024,1023,0),this.mkTag(0,0,0),r,a,-r,this.dirCommitCommit.bind(this),h),l){if(-84==l)break e;return l}if(!this.pairIsnull(t.tail)&&(this.pairTole32(t.tail),l=this.dirCommitattr(h,this.mkTag(1536+t.split,1023,8),t.tail),this.pairFromle32(t.tail),l)){if(-84==l)break e;return l}let f=new GState({tag:0});if(c||(this.gstateXor(f,this.gdisk),this.gstateXor(f,this.gstate)),this.gstateXor(f,this.gdelta),f.tag&=~this.mkTag(0,0,1023),l=this.dirGetgstate(t,f),l)return l;if(!this.gstateIszero(f)&&(this.gstateTole32(f),l=this.dirCommitattr(h,this.mkTag(2047,1023,struct.calcsize("III")),f),l)){if(-84==l)break e;return l}if(l=this.dirCommitcrc(h),l){if(-84==l)break e;return l}console.assert(h.off%this.cfg.progSize==0),this.pairSwap(t.pair),t.count=a-r,t.off=h.off,t.etag=h.ptag,this.gdelta=new GState({tag:0}),c||(this.gdisk=this.gstate);break t}if(c=!0,this.cacheDrop(this.pcache),l||console.warn("Bad block at "+toHex(t.pair[1],8)),0==this.pairCmp(t.pair,[0,1]))return console.warn("Superblock "+toHex(t.pair[1],8)+" has become unwritable"),-28;let h=new ByRef,o=this.alloc(h);if(t.pair[1]=h.get(),o&&(-28!=o||!l))return o;l=!1}if(c){console.warn("Relocating {"+toHex(h[0],8)+", "+toHex(h[1],8)+"} -> {"+toHex(t.pair[0],8)+", "+toHex(t.pair[1],8)+"}");let e=this.fsRelocate(h,t.pair);if(e)return e}return 0}dirTraverse(t,e,i,s,r,a,h,c,l,f,o,n){let g=0;for(;;){let u,p,m=new Diskoff;if(e+this.tagDsize(i)<t.off){e+=this.tagDsize(i);let s=new ByRef,r=this.bdRead(null,this.rcache,struct.calcsize("I"),t.pair[0],e,s,struct.calcsize("I"));if(u=s.get(),r)return r;u=(this.fromBe32(u)^i)>>>0|2147483648,m.block=t.pair[0],m.off=e+struct.calcsize("I"),p=m,i=u}else{if(!(r>0))return 0;u=s[g].tag,p=s[g].buffer,g+=1,r-=1}let d=this.mkTag(2047,0,0);if((d&a&u)==(d&a&h)){if(0!=this.tagId(a)){let a=this.dirTraverse(t,e,i,s,r,0,0,0,0,0,this.dirTraverseFilter.bind(this),u);if(a<0)return a;if(a)continue;if(!(this.tagId(u)>=c&&this.tagId(u)<l))continue}if(0==this.tagType3(u));else if(257==this.tagType3(u)){let t=this.tagSize(u),e=this.tagId(u),i=this.dirTraverse(p,0,4294967295,null,0,this.mkTag(1536,1023,0),this.mkTag(512,0,0),t,t+1,e-t+f,o,n);if(i)return i}else if(258==this.tagType3(u)){let t=p;for(let e=0;e<this.tagSize(u);e++){let i=o(n,this.mkTag(768+t[e].type,this.tagId(u)+f,t[e].size),t[e].buffer);if(i)return i}}else{let t=o(n,u+this.mkTag(0,f,0),p);if(t)return t}}}}dirTraverseFilter(t,e,i){let s=t,r=e&this.mkTag(256,0,0)?this.mkTag(2047,1023,0):this.mkTag(1792,1023,0);return!((r&e)!=(r&s)&&!this.tagIsdelete(s)&&(this.mkTag(2047,1023,0)&e)!=(this.mkTag(1279,0,0)|this.mkTag(0,1023,0)&s))||(1024==this.tagType1(e)&&this.tagId(e)<=this.tagId(s)&&(s+=this.mkTag(0,this.tagSplice(e),0)),!1)}dirSplit(){console.warn("dirSplit not implemented")}dirFind(t,e,i){i.get()&&i.set(1023);let s=0,r=e.get(),a=this.mkTag(2,1023,0);for(t.tail[0]=this.root[0],t.tail[1]=this.root[1];;){s+=r.indexOf("/")+1;let h=r.slice(s).indexOf("/");if(-1==h&&(h=r.slice(s).length),1==h&&"."==r.substr(s,1)||2==h&&".."==r.substr(s,2)){s+=h;continue}let c,l=r.substr(s+h),f=1;for(;l+=r.indexOf("/")+1,c=r.slice(l).indexOf("/"),!(c<=0);){if(2==c&&".."==r.substr(l,2)){if(f-=1,0==f){s=l+c;continue}}else f+=1;l+=c}if(s==r.length)return a;if(r=r.slice(s),e.set(r),s=0,2!=this.tagType3(a))return-20;if(1023!=this.tagId(a)){let e=this.dirGet(t,this.mkTag(1792,1023,0),this.mkTag(512,this.tagId(a),8),t.tail);if(e<0)return e;this.pairFromle32(t.tail)}for(;;){if(a=this.dirFetchmatch(t,t.tail,this.mkTag(1920,0,0),this.mkTag(0,0,h),r.slice(s).indexOf("/")<0?i:new ByRef(null),this.dirFindMatch.bind(this),new DirFindMatch({name:r.slice(s),size:h})),a<0)return a;if(a)break;if(!t.split)return-2}s+=h}}dirCommitCommit(t,e,i){return this.dirCommitattr(t,e,i)}dirCommitcrc(t){const e=this.alignup(t.off+2*struct.calcsize("I"),this.cfg.progSize);let i=0,s=0;for(;t.off<e;){let r=t.off+struct.calcsize("I"),a=Math.min(e-r,1022)+r;a<e&&(a=Math.min(a,e-struct.calcsize("II")));let h=4294967295,c=new ByRef,l=this.bdRead(null,this.rcache,struct.calcsize("I"),t.block,a,c,struct.calcsize("I"));if(l&&-84!=l)return l;h=c.get();let f=~this.fromBe32(h)>>>31?1:0;h=this.mkTag(1280+f,1023,a-r);let o=new Array(2);if(o[0]=this.toBe32((h^t.ptag)>>>0),t.crc=this.crc(t.crc,o[0],struct.calcsize("I")),o[1]=this.tole32(t.crc),l=this.bdProg(this.pcache,this.rcache,!1,t.block,t.off,o,struct.calcsize("II")),l)return l;0==i&&(i=t.off+struct.calcsize("I"),s=t.crc),t.off+=struct.calcsize("I")+this.tagSize(h),t.ptag=(h^f<<31)>>>0,t.crc=4294967295}let r=this.bdSync(this.pcache,this.rcache,!1);if(r)return r;let a=t.begin,h=i;for(;a<e;){let c=4294967295;for(let e=a;e<h+struct.calcsize("I");e++){if(e==i&&c!=s)return-84;let a=new ByRef;if(r=this.bdRead(null,this.rcache,h+struct.calcsize("I")-e,t.block,e,a,1),r)return r;let l=a.get();c=this.crc(c,l,1)}if(0!=c)return-84;a=Math.min(e-h,1022)+h,a<e&&(a=Math.min(a,e-2*struct.calcsize("I"))),h=a+struct.calcsize("I")}return 0}fsRawsize(){console.warn("fsRawsize not implemented")}dirCommitSize(){console.warn("dirCommitSize not implemented")}dirCommitattr(t,e,i){let s=this.tagDsize(e);if(t.off+s>t.end)return-28;let r=this.toBe32((2147483647&e^t.ptag)>>>0),a=this.dirCommitprog(t,r,struct.calcsize("I"));if(a)return a;if(2147483648&e){let e=i;for(let i=0;i<s-struct.calcsize("I");i++){let r=new ByRef;a=this.bdRead(null,this.rcache,s-struct.calcsize("I")-i,e.block,e.off+i,r,1);let h=r.get();if(a)return a;if(a=this.dirCommitprog(t,h,1),a)return a}}else if(a=this.dirCommitprog(t,i,s-struct.calcsize("I")),a)return a;return t.ptag=2147483647&e,0}dirDrop(){console.warn("dirDrop not implemented")}dirGetread(){console.warn("dirGetread not implemented")}dirGet(t,e,i,s){return this.dirGetslice(t,e,i,0,s,this.tagSize(i))}dirGetslice(t,e,i,s,r,a){let h=t.off,c=t.etag,l=0;for(this.gstateHasmovehere(this.gdisk,t.pair)&&0!=this.tagId(e)&&this.tagId(this.gdisk.tag)<=this.tagId(i)&&(l-=this.mkTag(0,1,0));h>=struct.calcsize("I")+this.tagDsize(c);){h-=this.tagDsize(c);let f=c,o=new ByRef,n=this.bdRead(null,this.rcache,struct.calcsize("I"),t.pair[0],h,o,struct.calcsize("I"));if(n)return n;if(c=o.get(),c=2147483647&(this.fromBe32(c)^f),0!=this.tagId(e)&&1024==this.tagType1(f)&&this.tagId(f)<=this.tagId(i-l)){if(f==(this.mkTag(1025,0,0)|this.mkTag(0,1023,0)&i-l))return-2;l+=this.mkTag(0,this.tagSplice(f),0)}if((e&f)==(e&i-l)){if(this.tagIsdelete(f))return-2;let e=Math.min(this.tagSize(f),a),i=new ByRef;return n=this.bdRead(null,this.rcache,e,t.pair[0],h+struct.calcsize("I")+s,i,e,!0),n?n:(r.data.set(i.get()),r.data.set(new Uint8Array(a-e).fill(0),e),f+l)}}return-2}dirGetgstate(t,e){let i=new GState,s=this.dirGet(t,this.mkTag(2047,0,0),this.mkTag(2047,0,struct.calcsize("III")),i);return s<0&&-2!=s?s:(-2!=s&&(this.gstateFromle32(i),this.gstateXor(e,i)),0)}cacheDrop(t){t.block=-1}cacheZero(t){t.buffer.fill(255),t.block=-1}fsPred(){console.warn("fsPred not implemented")}fsRelocate(){console.warn("fsRelocate not implemented")}gstateXor(t,e){t.tag^=e.tag,t.pair[0]^=e.pair[0],t.pair[1]^=e.pair[1]}gstateIszero(t){return 0===t.tag&&0===t.pair[0]&&0===t.pair[1]}gstateTole32(t){t.tag=this.tole32(t.tag),t.pair[0]=this.tole32(t.pair[0]),t.pair[1]=this.tole32(t.pair[1])}gstateFromle32(t){t.tag=this.fromle32(t.tag),t.pair[0]=this.fromle32(t.pair[0]),t.pair[1]=this.fromle32(t.pair[1])}scmp(t,e){return parseInt(t-e)}tole32(t){return this.fromle32(t)}fromle32(t){const e=Array.from(LittleFS.UintToBuffer(t,4));return(t=e[0]<<0|e[1]<<8|e[2]<<16|e[3]<<24)>>>0}toBe32(t){return this.fromBe32(t)}fromBe32(t){const e=Array.from(LittleFS.UintToBuffer(t,4));return(t=e[0]<<24|e[1]<<16|e[2]<<8|e[3]<<0)>>>0}ctzFromle32(t){t.head=this.fromle32(t.head),t.size=this.fromle32(t.size)}ctzTole32(t){t.head=this.tole32(t.head),t.size=this.tole32(t.size)}pairFromle32(t){t[0]=this.fromle32(t[0]),t[1]=this.fromle32(t[1])}pairTole32(t){t[0]=this.tole32(t[0]),t[1]=this.tole32(t[1])}superblockTole32(t){t.version=this.tole32(t.version),t.blockSize=this.tole32(t.blockSize),t.blockCount=this.tole32(t.blockCount),t.nameMax=this.tole32(t.nameMax),t.fileMax=this.tole32(t.fileMax),t.attrMax=this.tole32(t.attrMax)}superblockFromle32(t){t.version=this.fromle32(t.version),t.blockSize=this.fromle32(t.blockSize),t.blockCount=this.fromle32(t.blockCount),t.nameMax=this.fromle32(t.nameMax),t.fileMax=this.fromle32(t.fileMax),t.attrMax=this.fromle32(t.attrMax)}fileOpen(t,e,i){let s=new FileConfig({attrCount:0});return this.fileOpencfg(t,e,i,s)}fileOpencfg(t,e,i,s){let r;t:{{if(2==(2&i)){let t=this.fsForceconsistency();if(t)return t}t.cfg=s,t.flags=i,t.pos=0,t.off=0,t.cache.buffer=null;let a=new ByRef(e),h=new ByRef(t.id),c=this.dirFind(t.m,a,h);if(t.id=h.get(),e=a.get(),c<0&&(-2!=c||1023==t.id)){r=c;break t}if(t.type=1,this.mlistAppend(t),-2==c){if(!(256&i)){r=-2;break t}let s=e.length;if(s>this.nameMax){r=-36;break t}if(r=this.dirCommit(t.m,this.mkAttrs([this.mkTag(1025,t.id,0),null],[this.mkTag(1,t.id,s),e],[this.mkTag(513,t.id,0),null])),r){r=-36;break t}c=this.mkTag(513,0,0)}else{if(512&i){r=-17;break t}if(1!=this.tagType3(c)){r=-21;break t}if(1024&i)c=this.mkTag(513,t.id,0),t.flags|=65536;else{if(c=this.dirGet(t.m,this.mkTag(1792,1023,0),this.mkTag(512,t.id,8),t.ctz),c<0){r=c;break t}this.ctzFromle32(t.ctz)}}for(let e=0;e<t.cfg.attr_count;e++){if(1==(1&t.flags)){let i=this.dirGet(t.m,this.mkTag(2047,1023,0),this.mkTag(768+t.cfg.attrs[e].type,t.id,t.cfg.attrs[e].size),t.cfg.attrs[e].buffer);if(i<0&&-2!=i){r=i;break t}}if(2==(2&t.flags)){if(t.cfg.attrs[e].size>this.attrMax){r=-28;break t}t.flags|=65536}}if(t.cfg.buffer)t.cache.buffer=t.cfg.buffer;else if(t.cache.buffer=new Uint8Array(this.cfg.cacheSize),!t.cache.buffer){r=-12;break t}if(this.cacheZero(t.cache),513==this.tagType3(c)&&(t.ctz.head=-2,t.ctz.size=this.tagSize(c),t.flags|=1048576,t.cache.block=t.ctz.head,t.cache.off=0,t.cache.size=this.cfg.cacheSize,t.ctz.size>0)){let e=this.dirGet(t.m,this.mkTag(1792,1023,0),this.mkTag(512,t.id,Math.min(t.cache.size,1022)),t.cache.buffer);if(e<0){r=e;break t}}return 0}}return t.flags|=524288,this.fileClose(t),r}fileWrite(t,e,i){console.assert(2==(2&t.flags));let s=0,r=i;if(262144&t.flags){let e=this.fileFlush(t);if(e)return e}if(2048&t.flags&&t.pos<t.ctz.size&&(t.pos=t.ctz.size),t.pos+i>this.fileMax)return-27;if(!(131072&t.flags)&&t.pos>t.ctz.size){let e=t.pos;for(t.pos=t.ctz.size;t.pos<e;){let e=this.fileWrite(t,0,1);if(e<0)return e}}if(1048576&t.flags&&Math.max(t.pos+r,t.ctz.size)>Math.min(1022,Math.min(this.cfg.cacheSize,(this.cfg.metadataMax?this.cfg.metadataMax:this.cfg.blockSize)/8))){let e=this.fileOutline(t);if(e)return t.flags|=524288,e}for(;r>0;){if(!(131072&t.flags)||t.off==this.cfg.blockSize){if(1048576&t.flags)t.block=-2,t.off=t.pos;else{if(!(131072&t.flags)&&t.pos>0){let e=this.ctzFind(null,t.cache,t.ctz.head,t.ctz.size,t.pos-1,t.block,t.off);if(e)return t.flags|=524288,e;this.cacheZero(t.cache)}this.allocAck();let e=this.ctzExtend(t.cache,this.rcache,t.block,t.pos,t.block,t.off);if(e)return t.flags|=524288,e}t.flags|=131072}let i=Math.min(r,this.cfg.blockSize-t.off);t:for(;;){e:{{let r=this.bdProg(t.cache,this.rcache,!0,t.block,t.off,e.slice(s),i);if(r){if(-84==r)break e;return t.flags|=524288,r}break t}}let r=this.fileRelocate(t);if(r)return t.flags|=524288,r}t.pos+=i,t.off+=i,s+=i,r-=i,this.allocAck()}return t.flags&=-524289,i}fileClose(t){let e=this.fileSync(t);return this.mlistRemove(t),t.cfg.buffer||(t.cache.buffer=null),e}fileSync(t){if(524288&t.flags)return 0;let e=this.fileFlush(t);if(e)return t.flags|=524288,e;if(65536&t.flags&&!this.pairIsnull(t.m.pair)){let i,s,r,a=new Ctz;if(1048576&t.flags?(i=513,s=t.cache.buffer,r=t.ctz.size):(i=514,a=t.ctz,this.ctzTole32(a),s=a,r=struct.calcsize("II")),e=this.dirCommit(t.m,this.mkAttrs([this.mkTag(i,t.id,r),s],[this.mkTag(258,t.id,t.cfg.attrCount),t.cfg.attrs])),e)return t.flags|=524288,e;t.flags&=-65537}return 0}setattr(t,e,i,s){return s>this.attrMax?-28:this.commitattr(t,e,i,s)}fileRelocate(t){for(;;){t:{{let i=new ByRef,s=this.alloc(i),r=i.get();if(s)return s;if(s=this.bdErase(r),s){if(-84==s)break t;return s}for(let i=0;i<t.off;i++){let a;if(1048576&t.flags){if(s=this.dirGetread(t.m,null,t.cache,t.off-i,this.mkTag(4095,511,0),this.mkTag(513,t.id,0),i,a,1),s)return s}else{var e=new ByRef;if(s=this.bdRead(t.cache,this.rcache,t.off-i,t.block,i,e,1),a=e.get(),s)return s}if(s=this.bdProg(this.pcache,this.rcache,!0,r,i,a,1),s){if(-84==s)break t;return s}}return t.cache.buffer.set(this.pcache.buffer.slice(0,this.cfg.cacheSize)),t.cache.block=this.pcache.block,t.cache.off=this.pcache.off,t.cache.size=this.pcache.size,this.cacheZero(this.pcache),t.block=r,t.flags|=131072,0}}console.warn("Bad block at "+toHex(nblock,8)),this.cacheDrop(this.pcache)}}fileOutline(t){t.off=t.pos,this.allocAck();let e=this.fileRelocate(t);return e||(t.flags&=-1048577,0)}fileFlush(t){if(262144&t.flags&&(1048576&t.flags||this.cacheDrop(t.cache),t.flags&=-262145),131072&t.flags){let e=t.pos;if(1048576&t.flags)t.pos=Math.max(t.pos,t.ctz.size);else{let e=new LfsFile({ctz:t.ctz,flags:1,pos:t.pos,cache:this.rcache});for(this.cacheDrop(this.rcache);t.pos<t.ctz.size;){let i,s=this.fileRead(e,i,1);if(s<0)return s;if(s=this.fileWrite(t,i,1),s<0)return s;-1!=this.rcache.block&&(this.cacheDrop(e.cache),this.cacheDrop(this.rcache))}for(;;){let e=this.bdFlush(t.cache,this.rcache,!0);if(!e)break;if(-84!=e)return e;if(console.warn("Bad block at "+toHex(t.block,8)),e=this.fileRelocate(t),e)return e}}t.ctz.head=t.block,t.ctz.size=t.pos,t.flags&=-131073,t.flags|=65536,t.pos=e}return 0}mlistRemove(t){for(let e=this.mlist;e;e=e.next)if(e==t){e=e.next;break}}mlistAppend(t){t.next=this.mList,this.mList=t}commitattr(t,e,i,s){let r=new MDir,a=new ByRef(t),h=this.dirFind(r,a,new ByRef(null));if(t=a.get(),h<0)return h;let c=this.tagId(h);if(1023==c){c=0;let t=this.dirFetch(r,this.root);if(t)return t}return this.dirCommit(r,this.mkAttrs([this.mkTag(768+e.charCodeAt(0),c,s),i]))}dirCommitprog(t,e,i){let s=this.bdProg(this.pcache,this.rcache,!1,t.block,t.off,e,i);return s||(t.crc=this.crc(t.crc,e,i),t.off+=i,0)}fsForceconsistency(){let t=this.fsDemove();return t||(t=this.fsDeorphan(),t||0)}fsDemove(){if(!this.gstateHasmove(this.gdisk))return 0;console.warn("Fixing move {"+toHex(this.gdisk.pair[0],8)+", "+toHex(this.gdisk.pair[1],8)+"} "+toHex(this.tagId(this.gdisk.tag),4));let t=new MDir,e=this.dirFetch(t,this.gdisk.pair);if(e)return e;let i=this.tagId(this.gdisk.tag);return this.fsPrepmove(1023,null),e=this.dirCommit(t,this.mkAttrs([this.mkTag(1279,i,0),null])),e||0}fsDeorphan(){if(!this.gstateHasorphans(this.gstate))return 0;let t=new MDir({split:!0,tail:[0,1]}),e=new MDir;for(;!this.pairIsnull(t.tail);){let i=this.dirFetch(e,t.tail);if(i)return i;if(!t.split){let s=new MDir,r=this.fsParent(t.tail,s);if(r<0&&-2!=r)return r;if(-2==r){if(console.warn("Fixing orphan {"+toHex(t.tail[0],8)+", "+toHex(t.tail[1],8)+"}"),i=this.dirDrop(t,e),i)return i;continue}let a=new Array(2),h=this.dirGet(s,this.mkTag(2047,1023,0),r,a);if(h<0)return h;if(this.pairFromle32(a),!this.pairSync(a,t.tail)){if(console.warn("Fixing half-orphan {"+toHex(t.tail[0],8)+", "+toHex(t.tail[1],8)+"} -> {"+toHex(a[0],8)+", "+toHex(a[1],8)+"}"),this.pairTole32(a),i=this.dirCommit(t,this.mkAttrs([this.mkTag(1536,1023,8),a])),this.pairFromle32(a),i)return i;continue}}t=e}return this.fsPreporphans(-this.gstateGetorphans(this.gstate))}ctzFind(){console.warn("ctzFind not implemented")}ctzExtend(){console.warn("ctzExtend not implemented")}ctzTraverse(){console.warn("ctzTraverse not implemented")}fsPreporphans(){console.warn("fsPreporphans not implemented")}fsPrepmove(){console.warn("fsPrepmove not implemented")}fsParent(){console.warn("fsParent not implemented")}pairSync(){console.warn("pairSync not implemented")}mkdir(t){let e=this.fsForceconsistency();if(e)return e;let i=new MList;i.next=this.mlist;let s=new ByRef,r=new ByRef(t);e=this.dirFind(i.m,r,s),t=r.get();let a=s.get();if(-2!=e||1023==a)return e<0?e:-17;let h=t.length;if(h>this.nameMax)return-36;if(this.allocAck(),dir=new MDir,e=this.dirAlloc(dir),e)return e;let c=i.m;for(;c.split;)if(e=lfs_dir_fetch(c,c.tail),e)return e;if(this.pairTole32(c.tail),e=this.dirCommit(dir,this.mkAttrs([this.mkTag(1536,1023,8),c.tail])),this.pairFromle32(c.tail),e)return e;if(i.m.split){if(e=this.fsPreporphans(1),e)return e;if(i.type=0,i.id=0,this.mlist=i,this.pairTole32(dir.pair),e=this.dirCommit(c,this.mkAttrs([this.mkTag(1536,1023,8),dir.pair])),this.pairFromle32(dir.pair),e)return this.mlist=i.next,e;if(this.mlist=i.next,e=this.fsPreporphans(-1),e)return e}return this.pairTole32(dir.pair),e=this.dirCommit(i.m,this.mkAttrs([this.mkTag(1025,a,0),null],[this.mkTag(2,a,h),t],[this.mkTag(512,a,8),dir.pair],[this.mkTagIf(!i.m.split,1536,1023,8),dir.pair])),this.pairFromle32(dir.pair),e||0}mkTag(t,e,i){return(t<<20|e<<10|i)>>>0}mkTagIf(t,e,i,s){return t?this.mkTag(e,i,s):this.mkTag(0,0,0)}mkTagIfElse(t,e,i,s,r,a,h){return t?this.mkTag(e,i,s):this.mkTag(r,a,h)}mkAttrs(...t){let e=[];for(let[i,s]of t)e.push(new MAttr({tag:i,buffer:s}));return e}copyObjProps(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])}}class LfsConfig{constructor({context:t=null,readSize:e=64,progSize:i=64,blockSize:s=0,blockCount:r=0,blockCycles:a=16,cacheSize:h=64,lookaheadSize:c=64,nameMax:l=32,fileMax:f=2147483647,attrMax:o=1022,flash:n=n}={}){this.context=t,this.readSize=e,this.progSize=i,this.blockSize=s,this.blockCount=r,this.blockCycles=a,this.cacheSize=h,this.lookaheadSize=c,this.nameMax=l,this.fileMax=f,this.attrMax=o,this.metadataMax=this.blockSize,this.flash=n}read(t,e,i,s){return i.set(this.flash.data.slice(this.blockSize*t+e,this.blockSize*t+e+s)),0}prog(t,e,i,s){return this.flash.data.set(i.slice(0,s),this.blockSize*t+e),0}erase(t){return this.flash.data.set(new Uint8Array(this.blockSize).fill(0),this.blockSize*t),0}sync(){return 0}readBuffer=null;progBuffer=null;lookaheadBuffer=null}class SuperBlock{constructor({version:t=0,blockSize:e=0,blockCount:i=0,nameMax:s=0,fileMax:r=0,attrMax:a=0}={}){this.version=t,this.blockSize=e,this.blockCount=i,this.nameMax=s,this.fileMax=r,this.attrMax=a}setFromBuffer(t){let e=LittleFS.bufferToUint(t,struct.calcsize("IIIIII"));Object.keys(this).forEach(((t,i)=>{this[t]=e[i]}))}}class ByRef{constructor(t=void 0){this.data=t}set(t){this.data=t}get(){return this.data}}class GState{constructor({tag:t=0,pair:e=[0,0]}={}){this.tag=t,this.pair=e}}class MList{constructor({id:t=0,type:e=0,m:i=new MDir}={}){this.id=t,this.type=e,this.m=i,this.next=null}}class MDir{constructor({pair:t=[0,0],rev:e=0,off:i=0,etag:s=0,count:r=0,erased:a=!1,split:h=!1,tail:c=[0,0]}={}){this.pair=t,this.rev=e,this.off=i,this.etag=s,this.count=r,this.erased=a,this.split=h,this.tail=c}}class MAttr{constructor({tag:t=null,buffer:e=null}={}){this.tag=t,this.buffer=e}}class Attr{constructor({type:t=0,buffer:e=null,size:i=0}={}){this.type=t,this.buffer=e,this.size=i}}class Diskoff{constructor({block:t,off:e}={}){this.block=t,this.off=e}}class Ctz{constructor({head:t=null,size:e=0}={}){this.head=t,this.size=e}setFromBuffer(t){let e=LittleFS.bufferToUint(t,struct.calcsize("II"));Object.keys(this).forEach(((t,i)=>{this[t]=e[i]}))}}class DirFindMatch{constructor({name:t=null,size:e=0}={}){this.name=t,this.size=e}}class Commit{constructor({block:t=0,off:e=0,ptag:i=0,crc:s=0,begin:r=0,end:a=0}={}){this.block=t,this.off=e,this.ptag=i,this.crc=s,this.begin=r,this.end=a}}class Cache{constructor({block:t=-1,off:e=0,size:i=0,buffer:s=null}={}){this.block=t,this.off=e,this.size=i,this.buffer=s}}class FileConfig{constructor({buffer:t=null,attrs:e=[],attrCount:i=0}={}){this.buffer=t,this.attrs=e,this.attrCount=i}}class LfsFile{constructor({id:t=1,type:e=0,m:i=new MDir,ctz:s=new Ctz,flags:r=0,pos:a=0,block:h=0,off:c=0,cache:l=new Cache,cfg:f=new FileConfig}={}){this.id=t,this.type=e,this.m=i,this.ctz=s,this.flags=r,this.pos=a,this.block=h,this.off=c,this.cache=l,this.cfg=f,this.next=null}}class struct{static lut={b:{u:DataView.prototype.getInt8,p:DataView.prototype.setInt8,bytes:1},B:{u:DataView.prototype.getUint8,p:DataView.prototype.setUint8,bytes:1},h:{u:DataView.prototype.getInt16,p:DataView.prototype.setInt16,bytes:2},H:{u:DataView.prototype.getUint16,p:DataView.prototype.setUint16,bytes:2},i:{u:DataView.prototype.getInt32,p:DataView.prototype.setInt32,bytes:4},I:{u:DataView.prototype.getUint32,p:DataView.prototype.setUint32,bytes:4},q:{u:DataView.prototype.getInt64,p:DataView.prototype.setInt64,bytes:8},Q:{u:DataView.prototype.getUint64,p:DataView.prototype.setUint64,bytes:8}};static pack(...t){let e=t[0],i=0,s=t.slice(1);if(e.replace(/[<>]/,"").length!=s.length)throw"Pack format to Argument count mismatch";let r=[],a=!0;for(let t=0;t<e.length;t++)"<"==e[t]?a=!0:">"==e[t]?a=!1:(h(e[t],s[i]),i++);function h(t,e){if(!(t in struct.lut))throw"Unhandled character '"+t+"' in pack format";let i=struct.lut[t].bytes,s=new DataView(new ArrayBuffer(i));struct.lut[t].p.bind(s)(0,e,a);for(let t=0;t<i;t++)r.push(s.getUint8(t))}return r}static unpack(t,e){let i=0,s=[],r=!0;for(let e of t)"<"==e?r=!0:">"==e?r=!1:a(e);function a(t){if(!(t in struct.lut))throw"Unhandled character '"+t+"' in unpack format";let a=struct.lut[t].bytes,h=new DataView(new ArrayBuffer(a));for(let t=0;t<a;t++)h.setUint8(t,255&e[i+t]);let c=struct.lut[t].u.bind(h);s.push(c(0,r)),i+=a}return s}static calcsize(t){let e=0;for(let i=0;i<t.length;i++)"<"!=t[i]&&">"!=t[i]&&(e+=struct.lut[t[i]].bytes);return e}}export{LittleFS,LfsConfig,LfsFile,LFS_O_RDONLY,LFS_O_WRONLY,LFS_O_RDWR,LFS_O_CREAT,LFS_O_EXCL,LFS_O_TRUNC,LFS_O_APPEND};
//# sourceMappingURL=/sm/78034dc40e224781f1584d8c53a99c8c38d3e414dbd54fd3301baca90b2f300a.map